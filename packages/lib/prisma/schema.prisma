datasource db {
  provider = "postgresql"
  url      = env("POSTGRES_PRISMA_URL")
}

generator client {
  provider = "prisma-client-js"
}

// User Models ==============================================================================================================================================================
// ==========================================================================================================================================================================
// ==========================================================================================================================================================================
model User {
  id                 String               @id @default(uuid())
  firstname          String
  lastname           String
  phone              String
  email              String               @unique
  profileImg         String?
  profileImgId       String?
  coverImg           String?
  coverImgId         String?
  dateOfBirth        DateTime?
  password           String
  role               UserRole             @default(USER)
  subscriptionStatus SubscriptionStatus
  projects           Project[]
  participants       ProjectParticipant[]
  clients            Client[]

  createdAt DateTime  @default(now())
  updatedAt DateTime  @default(now())
  deletedAt DateTime?
}

enum SubscriptionStatus {
  INACTIVE
  CREATOR
  INNOVATOR
  VISIONARY

  // Fall back options
  // ESSENTIAL 
  // PROFESSIONAL 
  // ENTERPRISE 
}

enum UserRole {
  ADMIN
  USER
  GUEST
}

// ==========================================================================================================================================================================
// ==========================================================================================================================================================================
// ==========================================================================================================================================================================

// Project Models ===========================================================================================================================================================
// ==========================================================================================================================================================================
// ==========================================================================================================================================================================
model Project {
  id           String               @id @default(uuid())
  user         User                 @relation(fields: [userId], references: [id])
  userId       String
  client       Client               @relation(fields: [clientId], references: [id])
  clientId     String
  name         String
  description  String
  status       ProjectStatus        @default(ACTIVE)
  budget       Decimal?             @db.Decimal(10, 2)
  phases       Phase[]
  attachments  ProjectAttachment[]
  messages     ProjectMessage[]
  participants ProjectParticipant[]

  startDate DateTime
  endDate   DateTime
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?
}

model Phase {
  id          String      @id @default(uuid())
  project     Project     @relation(fields: [projectId], references: [id])
  projectId   String
  type        PhaseType
  name        String
  description String?
  startDate   DateTime
  endDate     DateTime
  status      PhaseStatus @default(PENDING)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum PhaseType {
  PLANNING
  DESIGN
  DEVELOPMENT
  TESTING
  FEEDBACK
  COMPLETED
}

enum PhaseStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  BLOCKED
}

enum ProjectStatus {
  DRAFT
  ACTIVE
  PAUSED
  COMPLETED
  ARCHIVED
  DELETED
}

model ProjectMessage {
  // Primary Relations
  id            String             @id @default(uuid())
  project       Project            @relation(fields: [projectId], references: [id])
  projectId     String
  participant   ProjectParticipant @relation(fields: [participantId], references: [id])
  participantId String

  // Data
  text        String
  attachments ProjectMessageAttachment[]

  // Dates
  createdAt   DateTime      @default(now())
  MessageRead MessageRead[]
}

model ProjectParticipant {
  id           String           @id @default(uuid())
  project      Project          @relation(fields: [projectId], references: [id])
  projectId    String
  user         User             @relation(fields: [userId], references: [id])
  userId       String
  role         ParticipantRole  @default(VIEWER)
  isActive     Boolean          @default(true)
  messages     ProjectMessage[]
  messageReads MessageRead[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([projectId, userId])
}

enum ParticipantRole {
  OWNER
  ADMIN
  EDITOR
  VIEWER
}

model MessageRead {
  id        String             @id @default(uuid())
  message   ProjectMessage     @relation(fields: [messageId], references: [id])
  messageId String
  readBy    ProjectParticipant @relation(fields: [readById], references: [id])
  readById  String
  readAt    DateTime           @default(now())

  @@unique([messageId, readById])
}

model ProjectAttachment {
  // Primary Relation
  id          String   @id @default(uuid())
  project     Project  @relation(fields: [projectId], references: [id])
  projectId   String
  blobUrl     String
  pathname    String
  contentType String
  createdAt   DateTime @default(now())
}

model ProjectMessageAttachment {
  // Primary Relation
  id          String         @id @default(uuid())
  message     ProjectMessage @relation(fields: [messageId], references: [id])
  messageId   String
  blobUrl     String
  pathname    String
  contentType String
  createdAt   DateTime       @default(now())
}

// ==========================================================================================================================================================================
// ==========================================================================================================================================================================
// ==========================================================================================================================================================================

// Client Models ===========================================================================================================================================================
// ==========================================================================================================================================================================
// ==========================================================================================================================================================================

model Client {
  id         String    @id @default(uuid())
  user       User      @relation(fields: [userId], references: [id])
  userId     String
  name       String
  email      String
  phone      String
  projects   Project[]
  isArchived Boolean   @default(false)

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  @@unique([userId, email])
}
