datasource db {
  provider = "postgresql"
  url      = env("POSTGRES_PRISMA_URL")
}

generator client {
  provider = "prisma-client-js"
}

// User Models ==============================================================================================================================================================
// ==========================================================================================================================================================================
// ==========================================================================================================================================================================
model User {
  id                 String             @id @default(uuid())
  firstname          String
  lastname           String
  phone              String
  email              String             @unique
  profileImg         String?
  profileImgId       String?
  coverImg           String?
  coverImgId         String?
  location           String?
  bio                String?
  dateOfBirth        DateTime?
  password           String
  role               UserRole           @default(USER)
  subscriptionStatus SubscriptionStatus
  projects           Project[]
  clients            Client[]

  // Calendar fields
  calendarEvent CalendarEvent[]

  createdAt DateTime  @default(now())
  updatedAt DateTime  @default(now())
  deletedAt DateTime?
}

enum SubscriptionStatus {
  INACTIVE
  CREATOR
  INNOVATOR
  VISIONARY
}

enum UserRole {
  ADMIN
  USER
  GUEST
  CLIENT
}

// ==========================================================================================================================================================================
// ==========================================================================================================================================================================
// ==========================================================================================================================================================================

// Project Models ===========================================================================================================================================================
// ==========================================================================================================================================================================
// ==========================================================================================================================================================================
model Project {
  id           String               @id @default(uuid())
  user         User                 @relation(fields: [userId], references: [id])
  userId       String
  client       Client               @relation(fields: [clientId], references: [id])
  clientId     String
  type         ProjectType?
  name         String
  description  String
  status       ProjectStatus        @default(PREPARATION)
  invoices     Invoice[] // Tracks actual invoices for the project
  phases       Phase[]
  attachments  ProjectAttachment[]
  messages     ProjectMessage[]
  participants ProjectParticipant[]

  // Portal fields
  portalSlug    String       @unique @default(cuid())
  portalPass    String
  portalEnabled Boolean      @default(true)
  portalViews   PortalView[]

  // Calendar fields
  calendarEvent CalendarEvent[]

  startDate DateTime
  endDate   DateTime
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?
}

model PortalView {
  id        String   @id @default(cuid())
  project   Project  @relation(fields: [projectId], references: [id])
  projectId String
  viewedAt  DateTime @default(now())
  ipAddress String?
}

enum ProjectType {
  BRANDING // Logo design, brand identity, style guides
  PHOTOGRAPHY // Photo shoots, image editing, photo collections
  ILLUSTRATION // Custom illustrations, art commissions
  WEB_DESIGN // Websites, landing pages, digital experiences
  VIDEO // Video production, editing, animation
  SOCIAL_MEDIA // Content creation, campaign management
  PRINT // Physical materials, packaging, editorial
  EXHIBITION // Art shows, installations, gallery work
  CAMPAIGN // Multi-channel creative campaigns
  COLLABORATION // Joint creative projects
}

enum PaymentSchedule {
  FULL_UPFRONT
  DEPOSIT_PLUS_FINAL
  MILESTONE_BASED
  INSTALLMENTS
  CUSTOM
}

enum PaymentMethod {
  BANK_TRANSFER
  CREDIT_CARD
  PAYPAL
  CASH
  CHECK
  OTHER
}

model Phase {
  id          String      @id @default(uuid())
  project     Project     @relation(fields: [projectId], references: [id])
  projectId   String
  order       Int         @default(autoincrement())
  type        PhaseType
  name        String
  description String?
  startDate   DateTime
  endDate     DateTime
  status      PhaseStatus @default(PENDING)
  invoice     Invoice[]

  // Calendar fields
  calendarEvent CalendarEvent[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum PhaseType {
  PREPARATION
  DESIGN
  DEVELOPMENT
  TESTING
  FEEDBACK
  COMPLETED
}

enum PhaseStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  BLOCKED
}

enum ProjectStatus {
  DRAFT
  PREPARATION
  ACTIVE
  PAUSED
  COMPLETED
  ARCHIVED
  DELETED
}

model ProjectMessage {
  id               String                     @id @default(uuid())
  project          Project                    @relation(fields: [projectId], references: [id])
  projectId        String
  participantEmail String
  text             String
  attachments      ProjectMessageAttachment[]
  createdAt        DateTime                   @default(now())
  MessageRead      MessageRead[]
}

model ProjectParticipant {
  id           String          @id @default(uuid())
  project      Project         @relation(fields: [projectId], references: [id])
  projectId    String
  role         ParticipantRole @default(VIEWER)
  isActive     Boolean         @default(true)
  email        String
  messageReads MessageRead[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([projectId, email])
}

enum ParticipantRole {
  OWNER
  ADMIN
  EDITOR
  VIEWER
}

model MessageRead {
  id        String             @id @default(uuid())
  message   ProjectMessage     @relation(fields: [messageId], references: [id])
  messageId String
  readBy    ProjectParticipant @relation(fields: [readById], references: [id])
  readById  String
  readAt    DateTime           @default(now())

  @@unique([messageId, readById])
}

model ProjectAttachment {
  id          String   @id @default(uuid())
  project     Project  @relation(fields: [projectId], references: [id])
  projectId   String
  blobUrl     String
  pathname    String
  contentType String
  createdAt   DateTime @default(now())
}

model ProjectMessageAttachment {
  id          String         @id @default(uuid())
  message     ProjectMessage @relation(fields: [messageId], references: [id])
  messageId   String
  blobUrl     String
  pathname    String
  contentType String
  createdAt   DateTime       @default(now())
}

// ==========================================================================================================================================================================
// ==========================================================================================================================================================================
// ==========================================================================================================================================================================

// Client Models ===========================================================================================================================================================
// ==========================================================================================================================================================================
// ==========================================================================================================================================================================

model Client {
  id         String    @id @default(uuid())
  user       User      @relation(fields: [userId], references: [id])
  userId     String
  name       String
  email      String
  phone      String
  projects   Project[]
  isArchived Boolean   @default(false)
  // paymentMethods PaymentMethod[]
  // preferredPaymentMethod PaymentMethod?

  // Calendar fields
  calendarEvent CalendarEvent[]

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  @@unique([userId, email])
}

// ==========================================================================================================================================================================
// ==========================================================================================================================================================================
// ==========================================================================================================================================================================

// Invoice  Models ===============================================================================================================================================
// ==========================================================================================================================================================================
// ==========================================================================================================================================================================

model Invoice {
  id            String         @id @default(uuid())
  project       Project?       @relation(fields: [projectId], references: [id])
  projectId     String?
  phase         Phase?         @relation(fields: [phaseId], references: [id]) // Optional relation to Phase
  phaseId       String?        @unique // Only used for milestone payments
  invoiceNumber String
  type          InvoiceType    @default(STANDARD)
  amount        String?
  status        InvoiceStatus  @default(SENT)
  dueDate       DateTime
  payments      Payment[] // Track all payments made against this invoice
  paymentMethod PaymentMethod? // Do we even need?
  notes         String?

  // Calendar fields
  calendarEvent CalendarEvent[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([projectId, invoiceNumber])
}

enum InvoiceType {
  STANDARD
  MILESTONE
  ADDITIONAL
}

enum InvoiceStatus {
  VOID
  DRAFT
  SENT
  PAID
  OVERDUE
  CANCELLED
}

enum PaymentType {
  DEPOSIT // Initial payment to start project
  INSTALLMENT // Regular partial payments
  MILESTONE // Payments tied to project phases... maybe
  ADDITIONAL // Extra work/changes/bonuses
  FINAL // Final payment to complete project
  OTHER
}

model Payment {
  id            String        @id @default(uuid())
  invoice       Invoice       @relation(fields: [invoiceId], references: [id])
  invoiceId     String
  amount        Decimal       @db.Decimal(10, 2)
  paymentMethod PaymentMethod
  status        PaymentStatus @default(PENDING)
  paidAt        DateTime?
  notes         String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum PaymentStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  REFUNDED
}

// ==========================================================================================================================================================================
// ==========================================================================================================================================================================
// ==========================================================================================================================================================================

// Calendar Models ===========================================================================================================================================================
// ==========================================================================================================================================================================
// ==========================================================================================================================================================================

// Calendar Models
model CalendarEvent {
  id          String              @id @default(uuid())
  title       String
  description String?
  startDate   DateTime
  endDate     DateTime?
  isAllDay    Boolean?            @default(false)
  type        CalendarEventType
  status      CalendarEventStatus @default(SCHEDULED)
  color       String? // For custom event coloring

  project   Project? @relation(fields: [projectId], references: [id])
  projectId String?
  phase     Phase?   @relation(fields: [phaseId], references: [id])
  phaseId   String?
  invoice   Invoice? @relation(fields: [invoiceId], references: [id])
  invoiceId String?
  user      User     @relation(fields: [userId], references: [id])
  userId    String
  client    Client?  @relation(fields: [clientId], references: [id])
  clientId  String?

  // Reminder settings
  reminders EventReminder[]

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  @@index([startDate])
  @@index([userId])
}

model EventReminder {
  id                  String        @id @default(uuid())
  calendarEvent       CalendarEvent @relation(fields: [calendarEventId], references: [id])
  calendarEventId     String
  reminderTime        DateTime
  emailEnabled        Boolean       @default(false)
  phoneEnabled        Boolean       @default(false)
  notificationEnabled Boolean       @default(false)
  sent                Boolean       @default(false)
  createdAt           DateTime      @default(now())
  updatedAt           DateTime      @updatedAt
}

enum CalendarEventType {
  PROJECT_TIMELINE // Overall project duration
  PHASE_DEADLINE // Individual phase deadlines
  INVOICE_DUE // Invoice due dates
  CLIENT_ANNIVERSARY // Client relationship anniversaries
  PLATFORM_MILESTONE // Platform usage milestones
  CUSTOM // For user-created custom events
}

enum CalendarEventStatus {
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}
