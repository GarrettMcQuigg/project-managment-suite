generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                  String              @id @default(uuid())
  firstname           String
  lastname            String
  phone               String
  email               String              @unique
  profileImg          String?
  profileImgId        String?
  coverImg            String?
  coverImgId          String?
  location            String?
  bio                 String?
  dateOfBirth         DateTime?
  password            String
  role                UserRole            @default(USER)
  stripeAccountId     String?             @map("stripe_account_id")
  stripeAccountStatus StripeAccountStatus @default(NOT_CONNECTED) @map("stripe_account_status")
  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @default(now())
  deletedAt           DateTime?
  analytics           Analytics?
  calendarEvent       CalendarEvent[]
  clients             Client[]
  invoices            Invoice[]
  pageView            PageView[]
  projects            Project[]
  subscription        Subscription?
  userActivity        UserActivity[]

  @@map("users")
}

model Project {
  id                   String               @id @default(uuid())
  userId               String
  clientId             String
  type                 ProjectType?
  name                 String
  description          String
  status               ProjectStatus        @default(PREPARATION)
  portalSlug           String               @unique @default(cuid())
  portalPass           String
  portalPassEncryption String
  portalEnabled        Boolean              @default(true)
  startDate            DateTime
  endDate              DateTime
  createdAt            DateTime             @default(now())
  updatedAt            DateTime             @updatedAt
  deletedAt            DateTime?
  calendarEvent        CalendarEvent[]
  checkpoints          Checkpoint[]
  invoices             Invoice[]
  portalViews          PortalView[]
  portalSessions       PortalSession[]
  client               Client               @relation(fields: [clientId], references: [id])
  user                 User                 @relation(fields: [userId], references: [id])
  projectAllocation    ProjectAllocation[]
  attachments          ProjectAttachment[]
  messages             ProjectMessage[]
  participants         ProjectParticipant[]
  projectPerformance   ProjectPerformance[]
  timeTracking         TimeTracking[]
}

model PortalView {
  id        String   @id @default(cuid())
  projectId String
  name      String
  viewedAt  DateTime @default(now())
  ipAddress String?
  project   Project  @relation(fields: [projectId], references: [id])
}

model PortalSession {
  id             String   @id @default(uuid())
  projectId      String
  visitorName    String
  ipAddress      String?
  userAgent      String?
  expiresAt      DateTime
  lastAccessedAt DateTime @default(now())
  createdAt      DateTime @default(now())
  project        Project  @relation(fields: [projectId], references: [id])

  @@index([projectId])
  @@index([expiresAt])
}

model Checkpoint {
  id            String           @id @default(uuid())
  projectId     String
  order         Int              @default(autoincrement())
  type          CheckpointType
  name          String
  description   String?
  startDate     DateTime
  endDate       DateTime
  status        CheckpointStatus @default(PENDING)
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt
  calendarEvent CalendarEvent[]
  project       Project          @relation(fields: [projectId], references: [id])
  invoice       Invoice?
  messages      ProjectMessage[]
}

model ProjectMessage {
  id                  String                     @id @default(uuid())
  projectId           String
  checkpointId        String?
  sender              String?
  text                String
  createdAt           DateTime                   @default(now())
  responseToMessageId String?
  messageRead         MessageRead[]
  checkpoint          Checkpoint?                @relation(fields: [checkpointId], references: [id])
  project             Project                    @relation(fields: [projectId], references: [id])
  responseToMessage   ProjectMessage?            @relation("MessageResponses", fields: [responseToMessageId], references: [id])
  responses           ProjectMessage[]           @relation("MessageResponses")
  attachments         ProjectMessageAttachment[]
}

model ProjectParticipant {
  id           String          @id @default(uuid())
  projectId    String
  role         ParticipantRole @default(VIEWER)
  isActive     Boolean         @default(true)
  email        String
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt
  messageReads MessageRead[]
  project      Project         @relation(fields: [projectId], references: [id])

  @@unique([projectId, email])
}

model MessageRead {
  id        String             @id @default(uuid())
  messageId String
  readById  String
  readAt    DateTime           @default(now())
  message   ProjectMessage     @relation(fields: [messageId], references: [id])
  readBy    ProjectParticipant @relation(fields: [readById], references: [id])

  @@unique([messageId, readById])
}

model ProjectAttachment {
  id          String   @id @default(uuid())
  projectId   String
  blobUrl     String
  pathname    String
  contentType String
  createdAt   DateTime @default(now())
  project     Project  @relation(fields: [projectId], references: [id])
}

model ProjectMessageAttachment {
  id          String         @id @default(uuid())
  messageId   String
  blobUrl     String
  pathname    String
  contentType String
  createdAt   DateTime       @default(now())
  message     ProjectMessage @relation(fields: [messageId], references: [id])
}

model Client {
  id                 String              @id @default(uuid())
  userId             String
  name               String
  email              String
  phone              String
  isArchived         Boolean             @default(false)
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  deletedAt          DateTime?
  calendarEvent      CalendarEvent[]
  user               User                @relation(fields: [userId], references: [id])
  clientEngagement   ClientEngagement[]
  clientInteractions ClientInteraction[]
  invoices           Invoice[]
  projects           Project[]

  @@unique([userId, email])
}

model Invoice {
  id                 String          @id @default(uuid())
  userId             String
  projectId          String?
  clientId           String?
  checkpointId       String?         @unique
  invoiceNumber      String
  type               InvoiceType     @default(STANDARD)
  amount             String?
  status             InvoiceStatus   @default(SENT)
  dueDate            DateTime
  notifyClient       Boolean?        @default(false)
  paymentMethod      PaymentMethod?
  notes              String?
  stripeCheckoutId   String?         @default("")
  stripeCheckoutUrl  String?         @default("")
  stripePaid         Boolean         @default(false)
  stripePaidAt       DateTime?
  notificationSent   Boolean         @default(false)
  notificationSentAt DateTime?
  createdAt          DateTime        @default(now())
  updatedAt          DateTime        @updatedAt
  calendarEvent      CalendarEvent[]
  checkpoint         Checkpoint?     @relation(fields: [checkpointId], references: [id])
  client             Client?         @relation(fields: [clientId], references: [id])
  project            Project?        @relation(fields: [projectId], references: [id])
  user               User            @relation(fields: [userId], references: [id])
  payments           Payment[]

  @@unique([projectId, invoiceNumber])
}

model Payment {
  id            String        @id @default(uuid())
  invoiceId     String
  amount        Decimal       @db.Decimal(10, 2)
  paymentMethod PaymentMethod
  status        PaymentStatus @default(PENDING)
  paidAt        DateTime?
  notes         String?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  invoice       Invoice       @relation(fields: [invoiceId], references: [id])
}

model CalendarEvent {
  id           String              @id @default(uuid())
  title        String
  description  String?
  startDate    DateTime
  endDate      DateTime?
  isAllDay     Boolean?            @default(false)
  type         CalendarEventType
  status       CalendarEventStatus @default(SCHEDULED)
  color        String?
  projectId    String?
  checkpointId String?
  invoiceId    String?
  userId       String
  clientId     String?
  createdAt    DateTime            @default(now())
  updatedAt    DateTime            @updatedAt
  deletedAt    DateTime?
  checkpoint   Checkpoint?         @relation(fields: [checkpointId], references: [id])
  client       Client?             @relation(fields: [clientId], references: [id])
  invoice      Invoice?            @relation(fields: [invoiceId], references: [id])
  project      Project?            @relation(fields: [projectId], references: [id])
  user         User                @relation(fields: [userId], references: [id])
  reminders    EventReminder[]

  @@index([startDate])
  @@index([userId])
}

model EventReminder {
  id                  String        @id @default(uuid())
  calendarEventId     String
  reminderTime        DateTime
  emailEnabled        Boolean       @default(false)
  phoneEnabled        Boolean       @default(false)
  notificationEnabled Boolean       @default(false)
  sent                Boolean       @default(false)
  createdAt           DateTime      @default(now())
  updatedAt           DateTime      @updatedAt
  calendarEvent       CalendarEvent @relation(fields: [calendarEventId], references: [id])
}

model Subscription {
  id                  String                @id @default(uuid())
  userId              String                @unique
  status              SubscriptionStatus    @default(ACTIVE)
  tierId              String
  currentPeriodStart  DateTime
  currentPeriodEnd    DateTime
  cancelAtPeriodEnd   Boolean               @default(false)
  billingCycle        BillingCycle          @default(MONTHLY)
  nextBillingDate     DateTime
  lastPaymentAttempt  DateTime?
  failedPaymentCount  Int                   @default(0)
  createdAt           DateTime              @default(now())
  updatedAt           DateTime              @updatedAt
  tier                SubscriptionPlan      @relation(fields: [tierId], references: [id])
  user                User                  @relation(fields: [userId], references: [id])
  subscriptionHistory SubscriptionHistory[]
}

model SubscriptionPlan {
  id                  String                @id @default(uuid())
  name                SubscriptionTierName  @unique
  displayName         String
  monthlyPrice        Decimal?              @db.Decimal(10, 2)
  annualPrice         Decimal?              @db.Decimal(10, 2)
  currency            String                @default("USD")
  projectLimit        Int?
  storageLimit        Int?
  clientLimit         Int?
  teamMemberLimit     Int?
  isActive            Boolean               @default(true)
  createdAt           DateTime              @default(now())
  updatedAt           DateTime              @updatedAt
  features            PlanFeature[]
  subscriptions       Subscription[]
  subscriptionHistory SubscriptionHistory[]
}

model PlanFeature {
  id                 String           @id @default(uuid())
  name               String
  description        String?
  subscriptionPlanId String
  createdAt          DateTime         @default(now())
  updatedAt          DateTime         @updatedAt
  subscriptionPlan   SubscriptionPlan @relation(fields: [subscriptionPlanId], references: [id])

  @@unique([subscriptionPlanId, name])
}

model SubscriptionHistory {
  id             String             @id @default(uuid())
  subscriptionId String
  planId         String
  status         SubscriptionStatus
  startDate      DateTime
  endDate        DateTime?
  createdAt      DateTime           @default(now())
  plan           SubscriptionPlan   @relation(fields: [planId], references: [id])
  subscription   Subscription       @relation(fields: [subscriptionId], references: [id])
}

model Analytics {
  id                     String                  @id @default(uuid())
  userId                 String                  @unique
  loginCount             Int                     @default(0)
  lastLogin              DateTime?
  projectsCreated        Int                     @default(0)
  projectsCompleted      Int                     @default(0)
  totalRevenue           Decimal                 @default(0) @db.Decimal(10, 2)
  activeClients          Int                     @default(0)
  responseRate           Decimal?                @db.Decimal(5, 2)
  avgResponseTime        Int?
  createdAt              DateTime                @default(now())
  updatedAt              DateTime                @updatedAt
  user                   User                    @relation(fields: [userId], references: [id])
  clientEngagement       ClientEngagement[]
  communicationAnalytics CommunicationAnalytics?
  monthlyRevenue         MonthlyRevenue[]
  performanceMetrics     PerformanceMetrics?
  timeTracking           TimeTracking[]
  workloadDistribution   WorkloadDistribution[]
}

model MonthlyRevenue {
  id          String    @id @default(uuid())
  analyticsId String
  month       DateTime
  amount      Decimal   @db.Decimal(10, 2)
  growth      Decimal?  @db.Decimal(5, 2)
  createdAt   DateTime  @default(now())
  analytics   Analytics @relation(fields: [analyticsId], references: [id])

  @@unique([analyticsId, month])
}

model ClientEngagement {
  id            String    @id @default(uuid())
  analyticsId   String
  clientId      String
  lastContact   DateTime
  messageCount  Int       @default(0)
  clientRevenue Decimal   @default(0) @db.Decimal(10, 2)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  analytics     Analytics @relation(fields: [analyticsId], references: [id])
  client        Client    @relation(fields: [clientId], references: [id])

  @@unique([analyticsId, clientId])
}

model UserActivity {
  id        String     @id @default(uuid())
  userId    String
  action    ActionType
  resource  String?
  timestamp DateTime   @default(now())
  user      User       @relation(fields: [userId], references: [id])

  @@index([userId, timestamp])
}

model TimeTracking {
  id          String    @id @default(uuid())
  analyticsId String
  projectId   String
  startTime   DateTime
  endTime     DateTime?
  duration    Int?
  description String?
  billable    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  analytics   Analytics @relation(fields: [analyticsId], references: [id])
  project     Project   @relation(fields: [projectId], references: [id])

  @@index([analyticsId, projectId])
  @@index([startTime, endTime])
}

model CommunicationAnalytics {
  id                       String              @id @default(uuid())
  analyticsId              String              @unique
  avgResponseTime          Int?
  previousAvgResponseTime  Int?
  messagesSent             Int                 @default(0)
  messagesReceived         Int                 @default(0)
  totalResponseTimeMinutes Int                 @default(0)
  responseCount            Int                 @default(0)
  createdAt                DateTime            @default(now())
  updatedAt                DateTime            @updatedAt
  clientInteractions       ClientInteraction[]
  analytics                Analytics           @relation(fields: [analyticsId], references: [id])
}

model ClientInteraction {
  id                       String                 @id @default(uuid())
  communicationAnalyticsId String
  clientId                 String
  lastInteraction          DateTime
  sentimentScore           Decimal?               @db.Decimal(3, 2)
  interactionCount         Int                    @default(0)
  averageResponseTime      Int?
  createdAt                DateTime               @default(now())
  updatedAt                DateTime               @updatedAt
  client                   Client                 @relation(fields: [clientId], references: [id])
  communicationAnalytics   CommunicationAnalytics @relation(fields: [communicationAnalyticsId], references: [id])

  @@unique([communicationAnalyticsId, clientId])
}

model PerformanceMetrics {
  id                    String               @id @default(uuid())
  analyticsId           String               @unique
  projectProfitability  Decimal              @default(0) @db.Decimal(10, 2)
  clientAcquisitionCost Decimal              @default(0) @db.Decimal(10, 2)
  clientLifetimeValue   Decimal              @default(0) @db.Decimal(10, 2)
  projectCompletionRate Decimal              @default(0) @db.Decimal(5, 2)
  onTimeDeliveryRate    Decimal              @default(0) @db.Decimal(5, 2)
  createdAt             DateTime             @default(now())
  updatedAt             DateTime             @updatedAt
  analytics             Analytics            @relation(fields: [analyticsId], references: [id])
  projectDetails        ProjectPerformance[]
}

model ProjectPerformance {
  id                   String             @id @default(uuid())
  performanceMetricsId String
  projectId            String
  estimatedHours       Int
  actualHours          Int
  estimatedCost        Decimal            @db.Decimal(10, 2)
  actualCost           Decimal            @db.Decimal(10, 2)
  revenue              Decimal            @db.Decimal(10, 2)
  profitMargin         Decimal            @db.Decimal(5, 2)
  createdAt            DateTime           @default(now())
  updatedAt            DateTime           @updatedAt
  performanceMetrics   PerformanceMetrics @relation(fields: [performanceMetricsId], references: [id])
  project              Project            @relation(fields: [projectId], references: [id])

  @@unique([performanceMetricsId, projectId])
}

model WorkloadDistribution {
  id                String              @id @default(uuid())
  analyticsId       String
  date              DateTime
  totalHours        Decimal             @default(0) @db.Decimal(5, 2)
  billableHours     Decimal             @default(0) @db.Decimal(5, 2)
  nonBillableHours  Decimal             @default(0) @db.Decimal(5, 2)
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  projectAllocation ProjectAllocation[]
  analytics         Analytics           @relation(fields: [analyticsId], references: [id])

  @@unique([analyticsId, date])
}

model ProjectAllocation {
  id                     String               @id @default(uuid())
  workloadDistributionId String
  projectId              String
  hoursAllocated         Decimal              @default(0) @db.Decimal(5, 2)
  percentageOfTotal      Decimal              @default(0) @db.Decimal(5, 2)
  createdAt              DateTime             @default(now())
  updatedAt              DateTime             @updatedAt
  project                Project              @relation(fields: [projectId], references: [id])
  workloadDistribution   WorkloadDistribution @relation(fields: [workloadDistributionId], references: [id])

  @@unique([workloadDistributionId, projectId])
}

model PageView {
  id         String   @id @default(uuid())
  userId     String
  page       Pages
  resourceId String?
  duration   Int?
  timestamp  DateTime @default(now())
  user       User     @relation(fields: [userId], references: [id])

  @@index([userId, timestamp])
}

enum UserRole {
  ADMIN
  USER
  GUEST
  CLIENT
}

enum StripeAccountStatus {
  NOT_CONNECTED
  PENDING
  VERIFIED
  RESTRICTED
}

enum ProjectType {
  BRANDING
  PHOTOGRAPHY
  ILLUSTRATION
  WEB_DESIGN
  VIDEO
  SOCIAL_MEDIA
  PRINT
  EXHIBITION
  CAMPAIGN
  COLLABORATION
  OTHER
}

enum PaymentSchedule {
  FULL_UPFRONT
  DEPOSIT_PLUS_FINAL
  MILESTONE_BASED
  INSTALLMENTS
  CUSTOM
}

enum PaymentMethod {
  BANK_TRANSFER
  CREDIT_CARD
  PAYPAL
  CASH
  CHECK
  OTHER
}

enum CheckpointType {
  PREPARATION
  DESIGN
  DEVELOPMENT
  TESTING
  FEEDBACK
  COMPLETED
}

enum CheckpointStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  BLOCKED
  PAUSED
}

enum ProjectStatus {
  DRAFT
  PREPARATION
  ACTIVE
  PAUSED
  COMPLETED
  ARCHIVED
  DELETED
}

enum ParticipantRole {
  OWNER
  ADMIN
  EDITOR
  VIEWER
}

enum InvoiceType {
  STANDARD
  MILESTONE
  ADDITIONAL
}

enum InvoiceStatus {
  VOID
  DRAFT
  SENT
  PAID
  PAYMENT_FAILED
  OVERDUE
  CANCELLED
}

enum PaymentType {
  DEPOSIT
  INSTALLMENT
  MILESTONE
  ADDITIONAL
  FINAL
  OTHER
}

enum PaymentStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  REFUNDED
}

enum CalendarEventType {
  PROJECT_TIMELINE
  CHECKPOINT_DEADLINE
  INVOICE_DUE
  CLIENT_ANNIVERSARY
  PLATFORM_MILESTONE
  CUSTOM
}

enum CalendarEventStatus {
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum SubscriptionStatus {
  ACTIVE
  PAST_DUE
  CANCELED
  UNPAID
  TRIALING
  PAUSED
}

enum SubscriptionTierName {
  INACTIVE
  CREATOR
  INNOVATOR
  VISIONARY
}

enum BillingCycle {
  MONTHLY
  ANNUALLY
}

enum ActionType {
  LOGIN
  LOGOUT
  CREATE_PROJECT
  UPDATE_PROJECT
  DELETE_PROJECT
  CREATE_CLIENT
  UPDATE_CLIENT
  DELETE_CLIENT
  CREATE_INVOICE
  UPDATE_INVOICE
  DELETE_INVOICE
  SEND_MESSAGE
  VIEW_MESSAGE
  CREATE_CHECKPOINT
  UPDATE_CHECKPOINT
  DELETE_CHECKPOINT
  CREATE_ATTACHMENT
  DELETE_ATTACHMENT
  CREATE_EVENT
  UPDATE_EVENT
  DELETE_EVENT
}

enum Pages {
  DASHBOARD
  PROJECT
  CLIENT
  INVOICE
  CALENDAR
  PROJECT_BOARD
  SUPPORT
  SETTINGS
}
